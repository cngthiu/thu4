<!-- src/main/resources/templates/books/index.html -->
<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="fragments/layout :: layout (~{::title}, ~{::section})"
>
  <head>
    <title>Books</title>
  </head>
  <body>
    <section class="container-fluid px-0">
      <div class="card app-card border-0 p-3 p-lg-4 mb-4">
        <div
          class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3"
        >
          <div>
            <h2 class="fw-semibold mb-1">Books catalog</h2>
          </div>
          <div class="d-flex flex-column flex-sm-row gap-2">
            <a
              class="btn btn-outline-primary"
              data-trigger-loading
              th:href="@{/books/export(q=${q}, authorId=${authorId}, categoryId=${categoryId}, status=${status}, minPrice=${minPrice}, maxPrice=${maxPrice}, sort=${sort})}"
            >
              <i class="bi bi-download me-1"></i> Export CSV
            </a>
            <a class="btn btn-primary" th:href="@{/books/new}">
              <i class="bi bi-plus-lg me-1"></i> New Book
            </a>
          </div>
        </div>

        <form id="bookFilters" class="mt-4" method="get" data-loading>
          <input
            type="hidden"
            name="page"
            id="booksPageInput"
            th:value="${booksPage.page()}"
          />
          <div class="row g-3 align-items-center">
            <div class="col-lg-5">
              <div class="input-group shadow-sm rounded-4 overflow-hidden">
                <span class="input-group-text border-0 bg-body-tertiary">
                  <i class="bi bi-search text-secondary"></i>
                </span>
                <input
                  class="form-control border-0"
                  type="search"
                  name="q"
                  placeholder="Search title, author, category…"
                  th:value="${q}"
                  data-debounce="500"
                  data-target-form="bookFilters"
                  data-reset-page="#booksPageInput"
                />
              </div>
            </div>
            <div class="col-md-3 col-lg-2">
              <select
                class="form-select shadow-sm"
                name="sort"
                data-auto-submit
                data-target-form="bookFilters"
                data-reset-page="#booksPageInput"
              >
                <option
                  value="title,asc"
                  th:selected="${sort == null or sort.startsWith('title')}"
                >
                  Sort by title
                </option>
                <option
                  value="price,asc"
                  th:selected="${sort != null and sort.startsWith('price') and !sort.endsWith('desc')}"
                >
                  Price ↑
                </option>
                <option
                  value="price,desc"
                  th:selected="${sort != null and sort.startsWith('price') and sort.endsWith('desc')}"
                >
                  Price ↓
                </option>
                <option
                  value="stock,desc"
                  th:selected="${sort != null and sort.startsWith('stock')}"
                >
                  Stock high
                </option>
              </select>
            </div>
            <div class="col-md-3 col-lg-2">
              <select
                class="form-select shadow-sm"
                name="size"
                data-auto-submit
                data-target-form="bookFilters"
                data-reset-page="#booksPageInput"
              >
                <option value="10" th:selected="${size == 10}">
                  10 / page
                </option>
                <option value="25" th:selected="${size == 25}">
                  25 / page
                </option>
                <option value="50" th:selected="${size == 50}">
                  50 / page
                </option>
              </select>
            </div>
            <div class="col-lg-3 text-lg-end">
              <div class="d-flex gap-2 justify-content-lg-end">
                <a
                  class="btn btn-link text-decoration-none text-muted"
                  th:href="@{/books}"
                  th:if="${q != null or authorId != null or categoryId != null or status != null or minPrice != null or maxPrice != null}"
                >
                  <i class="bi bi-x-circle me-1"></i>Clear filters
                </a>
                <button
                  class="btn btn-outline-secondary d-none d-lg-inline-flex"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#advancedFilters"
                  aria-expanded="false"
                  aria-controls="advancedFilters"
                >
                  <i class="bi bi-sliders me-1"></i>Filters
                </button>
                <button
                  class="btn btn-outline-secondary d-inline-flex d-lg-none"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#advancedFilters"
                  aria-expanded="false"
                  aria-controls="advancedFilters"
                >
                  <i class="bi bi-sliders"></i>
                </button>
                <button class="btn btn-primary" type="submit">
                  <i class="bi bi-arrow-repeat me-1"></i>Apply
                </button>
              </div>
            </div>
          </div>

          <div class="collapse mt-3" id="advancedFilters">
            <div class="row g-3">
              <div class="col-md-3">
                <label
                  class="form-label small text-uppercase text-muted fw-semibold mb-1"
                  >Author</label
                >
                <select
                  class="form-select"
                  name="authorId"
                  data-auto-submit
                  data-target-form="bookFilters"
                  data-reset-page="#booksPageInput"
                >
                  <option value="">All authors</option>
                  <option
                    th:each="author : ${authors}"
                    th:value="${author.authorId}"
                    th:selected="${author.authorId == authorId}"
                    th:text="${author.name}"
                  ></option>
                </select>
              </div>
              <div class="col-md-3">
                <label
                  class="form-label small text-uppercase text-muted fw-semibold mb-1"
                  >Category</label
                >
                <select
                  class="form-select"
                  name="categoryId"
                  data-auto-submit
                  data-target-form="bookFilters"
                  data-reset-page="#booksPageInput"
                >
                  <option value="">All categories</option>
                  <option
                    th:each="category : ${categories}"
                    th:value="${category.categoryId}"
                    th:selected="${category.categoryId == categoryId}"
                    th:text="${category.name}"
                  ></option>
                </select>
              </div>
              <div class="col-md-2">
                <label
                  class="form-label small text-uppercase text-muted fw-semibold mb-1"
                  >Status</label
                >
                <select
                  class="form-select"
                  name="status"
                  data-auto-submit
                  data-target-form="bookFilters"
                  data-reset-page="#booksPageInput"
                >
                  <option value="">Any status</option>
                  <option
                    th:each="s : ${statuses}"
                    th:value="${s}"
                    th:selected="${status != null and status.equalsIgnoreCase(s.name())}"
                    th:text="${s.name()}"
                  ></option>
                </select>
              </div>
              <div class="col-md-2">
                <label
                  class="form-label small text-uppercase text-muted fw-semibold mb-1"
                  >Min price</label
                >
                <input
                  class="form-control"
                  type="number"
                  name="minPrice"
                  min="0"
                  step="0.01"
                  th:value="${minPrice}"
                  data-debounce="600"
                  data-target-form="bookFilters"
                  data-reset-page="#booksPageInput"
                />
              </div>
              <div class="col-md-2">
                <label
                  class="form-label small text-uppercase text-muted fw-semibold mb-1"
                  >Max price</label
                >
                <input
                  class="form-control"
                  type="number"
                  name="maxPrice"
                  min="0"
                  step="0.01"
                  th:value="${maxPrice}"
                  data-debounce="600"
                  data-target-form="bookFilters"
                  data-reset-page="#booksPageInput"
                />
              </div>
            </div>
          </div>
        </form>

        <div
          class="d-flex flex-wrap gap-2 mt-3"
          th:if="${booksPage.total() > 0 and (q != null or authorId != null or categoryId != null or status != null or minPrice != null or maxPrice != null)}"
        >
          <span class="filter-pill" th:if="${q != null}">
            <i class="bi bi-search"></i>
            <span th:text="${q}">Search</span>
          </span>
          <span class="filter-pill" th:if="${authorId != null}">
            <i class="bi bi-person"></i>
            <span>Author ID <span th:text="${authorId}"></span></span>
          </span>
          <span class="filter-pill" th:if="${categoryId != null}">
            <i class="bi bi-tag"></i>
            <span>Category ID <span th:text="${categoryId}"></span></span>
          </span>
          <span class="filter-pill" th:if="${status != null}">
            <i class="bi bi-flag"></i>
            <span th:text="${status}">Status</span>
          </span>
          <span class="filter-pill" th:if="${minPrice != null}">
            <i class="bi bi-currency-dollar"></i>
            <span>Min <span th:text="${minPrice}">0</span></span>
          </span>
          <span class="filter-pill" th:if="${maxPrice != null}">
            <i class="bi bi-currency-dollar"></i>
            <span>Max <span th:text="${maxPrice}">0</span></span>
          </span>
        </div>
      </div>

      <div class="card app-card border-0 p-0">
        <div class="table-responsive">
          <table class="table align-middle mb-0 app-table">
            <thead>
              <tr class="text-uppercase small text-muted">
                <th scope="col">ID</th>
                <th scope="col">Cover</th>
                <th scope="col">Title</th>
                <th scope="col">Author</th>
                <th scope="col">Category</th>
                <th scope="col" class="text-end">Price</th>
                <th scope="col" class="text-end">Stock</th>
                <th scope="col">Status</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr
                th:each="book, stat : ${books}"
                data-animate-row
                th:classappend="${stat.index % 2 == 0 ? ' table-light' : ''}"
              >
                <td class="fw-semibold text-muted" th:text="${book.bookId}">
                  1
                </td>
                <td>
                  <div class="book-cover-holder">
                    <img
                      th:if="${book.coverPath() != null}"
                      th:src="@{/covers/{file}(file=${book.coverPath()})}"
                      alt="Cover"
                      class="book-cover-thumb"
                    />
                    <div
                      th:if="${book.coverPath() == null}"
                      class="book-cover-placeholder"
                    >
                      <i class="bi bi-image"></i>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="fw-semibold" th:text="${book.title}">
                    Book title
                  </div>
                  <small class="text-muted d-none d-lg-inline"
                    >#<span th:text="${book.bookId}">0</span></small
                  >
                </td>
                <td
                  th:text="${book.authorName != null ? book.authorName : 'Unknown'}"
                >
                  Author
                </td>
                <td
                  th:text="${book.categoryName != null ? book.categoryName : 'Unknown'}"
                >
                  Category
                </td>
                <td
                  class="text-end fw-semibold"
                  th:text="${book.price != null ? #numbers.formatDecimal(book.price, 0, 'COMMA', 2, 'POINT') : '—'}"
                >
                  0
                </td>
                <td class="text-end">
                  <span
                    class="badge rounded-pill"
                    th:classappend="${book.stock != null and book.stock > 5} ? ' bg-success-subtle text-success' : ' bg-warning-subtle text-warning'"
                    th:text="${book.stock}"
                    >0</span
                  >
                </td>
                <td>
                  <span
                    class="badge badge-status text-uppercase fw-semibold"
                    th:classappend="${book.status != null ? ' badge-status-' + #strings.toLowerCase(book.status.name()) : ' badge-status-unknown'}"
                    th:text="${book.status != null ? book.status.name() : 'UNKNOWN'}"
                    >AVAILABLE</span
                  >
                </td>
                <td class="text-end">
                  <div class="d-flex justify-content-end gap-2">
                    <a
                      class="btn btn-outline-primary btn-sm"
                      th:href="@{|/books/${book.bookId}/edit|}"
                    >
                      <i class="bi bi-pencil-square"></i>
                    </a>
                    <form
                      th:action="@{|/books/${book.bookId}/delete|}"
                      method="post"
                      data-confirm="Delete this book?"
                      data-loading
                      class="d-inline"
                    >
                      <button
                        class="btn btn-outline-danger btn-sm"
                        type="submit"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(books)}">
                <td colspan="9" class="text-center py-5">
                  <div class="text-muted">
                    <i class="bi bi-archive mb-2" style="font-size: 2rem"></i>
                    <p class="mb-0">No books found with current filters.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div
          class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between p-3"
        >
          <p
            class="mb-2 mb-lg-0 small text-muted"
            th:text="'Showing ' + ${books.size()} + ' of ' + ${booksPage.total()} + ' books'"
          >
            Showing 0 of 0 books
          </p>
          <nav
            aria-label="Books pagination"
            th:if="${booksPage.totalPages() > 1}"
            th:with="total=${T(java.lang.Math).toIntExact(booksPage.totalPages())},
                    current=${booksPage.page()},
                    prev=${current > 0 ? current - 1 : 0},
                    next=${current + 1 < total ? current + 1 : current}"
          >
            <ul class="pagination pagination-sm mb-0 app-pagination">
              <li
                class="page-item"
                th:classappend="${current == 0} ? ' disabled'"
              >
                <a
                  class="page-link"
                  th:href="@{/books(q=${q}, authorId=${authorId}, categoryId=${categoryId}, status=${status}, minPrice=${minPrice}, maxPrice=${maxPrice}, size=${size}, sort=${sort}, page=${prev})}"
                >
                  Prev
                </a>
              </li>
              <li
                class="page-item"
                th:each="p : ${#numbers.sequence(0, total - 1)}"
                th:classappend="${p == current} ? ' active'"
              >
                <a
                  class="page-link"
                  th:text="${p + 1}"
                  th:href="@{/books(q=${q}, authorId=${authorId}, categoryId=${categoryId}, status=${status}, minPrice=${minPrice}, maxPrice=${maxPrice}, size=${size}, sort=${sort}, page=${p})}"
                  >1</a
                >
              </li>
              <li
                class="page-item"
                th:classappend="${current + 1 >= total} ? ' disabled'"
              >
                <a
                  class="page-link"
                  th:href="@{/books(q=${q}, authorId=${authorId}, categoryId=${categoryId}, status=${status}, minPrice=${minPrice}, maxPrice=${maxPrice}, size=${size}, sort=${sort}, page=${next})}"
                >
                  Next
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </section>
  </body>
</html>
